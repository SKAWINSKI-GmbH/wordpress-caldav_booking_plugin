name: CI/CD

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main]

jobs:
  # ============================================
  # PHP Syntax & Standards Check
  # ============================================
  lint:
    name: PHP Lint & Standards
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['7.4', '8.0', '8.1', '8.2', '8.3']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: composer, phpcs, phpcbf
          coverage: none
      
      - name: PHP Syntax Check
        run: find . -name "*.php" -exec php -l {} \;
      
      - name: Install PHP_CodeSniffer WordPress Standards
        run: |
          composer global config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer global require wp-coding-standards/wpcs --no-interaction
          phpcs --config-set installed_paths $(composer global config home)/vendor/wp-coding-standards/wpcs
      
      - name: Run PHPCS (WordPress Standards)
        run: phpcs --standard=WordPress --extensions=php --ignore=vendor,node_modules --warning-severity=0 . || true
        continue-on-error: true

  # ============================================
  # JavaScript Lint
  # ============================================
  js-lint:
    name: JavaScript Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install ESLint
        run: npm install -g eslint
      
      - name: Run ESLint
        run: eslint assets/*.js --no-eslintrc --env browser,jquery --globals caldavBooking || true
        continue-on-error: true

  # ============================================
  # Security Scan
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      
      - name: Check for common security issues
        run: |
          echo "Checking for potential security issues..."
          
          # Check for eval() usage
          if grep -r "eval(" --include="*.php" .; then
            echo "⚠️ Warning: eval() found"
          fi
          
          # Check for unescaped output
          if grep -rE "echo\s+\\\$_(GET|POST|REQUEST)" --include="*.php" .; then
            echo "⚠️ Warning: Potentially unescaped user input"
          fi
          
          # Check for direct SQL queries without prepare
          if grep -rE "\\\$wpdb->(query|get_)" --include="*.php" . | grep -v "prepare"; then
            echo "⚠️ Warning: SQL query without prepare() - verify manually"
          fi
          
          echo "✅ Security scan completed"

  # ============================================
  # WordPress Plugin Check
  # ============================================
  wp-check:
    name: WordPress Compatibility
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify Plugin Header
        run: |
          echo "Checking plugin header..."
          if grep -q "Plugin Name:" caldav-booking.php; then
            echo "✅ Plugin header found"
          else
            echo "❌ Plugin header missing"
            exit 1
          fi
      
      - name: Check required files
        run: |
          echo "Checking required files..."
          files=("caldav-booking.php" "README.md" "LICENSE" "readme.txt" "assets/booking.js" "assets/booking.css")
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ $file exists"
            else
              echo "❌ $file missing"
              exit 1
            fi
          done

  # ============================================
  # Build Release ZIP
  # ============================================
  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [lint, js-lint, security, wp-check]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Update version in plugin file
        run: |
          sed -i "s/Version: .*/Version: ${{ steps.get_version.outputs.VERSION }}/" caldav-booking.php
          sed -i "s/define('CALDAV_BOOKING_VERSION', '.*')/define('CALDAV_BOOKING_VERSION', '${{ steps.get_version.outputs.VERSION }}')/" caldav-booking.php
      
      - name: Create plugin directory
        run: |
          mkdir -p build/caldav-booking-plugin
          cp -r caldav-booking.php README.md LICENSE readme.txt assets build/caldav-booking-plugin/
      
      - name: Create ZIP archive
        run: |
          cd build
          zip -r caldav-booking-plugin-${{ steps.get_version.outputs.VERSION }}.zip caldav-booking-plugin
          mv caldav-booking-plugin-${{ steps.get_version.outputs.VERSION }}.zip ../
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: caldav-booking-plugin-${{ steps.get_version.outputs.VERSION }}
          path: caldav-booking-plugin-${{ steps.get_version.outputs.VERSION }}.zip

  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: caldav-booking-plugin-${{ steps.get_version.outputs.VERSION }}
      
      - name: Generate Changelog
        id: changelog
        run: |
          echo "## Changes in v${{ steps.get_version.outputs.VERSION }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> CHANGELOG.md 2>/dev/null || echo "- Initial release" >> CHANGELOG.md
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: CalDAV Booking v${{ steps.get_version.outputs.VERSION }}
          body_path: CHANGELOG.md
          files: caldav-booking-plugin-${{ steps.get_version.outputs.VERSION }}.zip
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
